<!DOCTYPE html>
<html lang="ar">
<head>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8296425494322351" crossorigin="anonymous"></script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>StarWhispers (Ù‡Ù…Ø³Ø§Øª Ø§Ù„Ù†Ø¬ÙˆÙ…)</title> 

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700&family=IBM+Plex+Mono:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
<style>
/* CSS Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ - ØªÙ… ØªØ­Ø³ÙŠÙ†Ù‡ Ù„Ù„Ø¬ÙˆØ§Ù„ */
html,body{
    height:100%;
    margin:0;
    background:#000;
    overflow:hidden;
    color:#fff;
    font-family: 'Cairo', system-ui, Segoe UI, Roboto, Arial, sans-serif;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}
canvas{
    display:block;
    width:100%;
    height:100%;
    touch-action: none;
}

#messageModal {
    position: fixed; 
    top: 50%;
    left: 50%;
    transform: translate(-50%,-50%); 
    background: rgba(0,0,0,0.95); 
    padding: 20px; 
    border-radius: 12px; 
    display: none; 
    z-index: 30; 
    color: #fff; 
    font-family: 'IBM Plex Mono', monospace; 
    width: 90vw;
    max-width: 90vw;
    text-align: center;
    box-sizing: border-box;
}
#messageModal input.titleInput { 
    width: 100%; 
    padding: 10px; 
    margin-bottom: 10px; 
    font-size: 16px; 
    border-radius: 6px; 
    border: 1px solid #555; 
    background: #111; 
    color: #0f0; 
    display: block; 
    box-sizing: border-box;
}
#messageModal textarea { 
    width: 100%; 
    min-height: 120px; 
    max-height: 50vh; 
    margin-bottom: 10px; 
    background: #111; 
    color: #ffa500;
    border: 1px solid #555; 
    border-radius: 6px; 
    padding: 10px; 
    resize: vertical; 
    font-family: 'IBM Plex Mono', monospace; 
    overflow-y: auto;
    box-sizing: border-box;
    font-size: 16px;
}
#messageModal button { 
    margin: 0 5px; 
    padding: 10px 15px; 
    border:none; 
    border-radius:6px; 
    cursor:pointer; 
    background: #0f0; 
    color: #000; 
    font-weight:bold;
    font-family: 'Cairo', sans-serif;
    font-size: 14px;
}
#messageModal button.cancel {
    background: #888; 
    color: #fff;
}

.starMessage { 
    position: fixed; 
    padding: 12px 15px; 
    background: rgba(0,0,0,0.95); 
    color: #ffa500; 
    border-radius: 8px; 
    font-family: 'IBM Plex Mono', monospace; 
    font-size: 16px; 
    pointer-events: auto; 
    opacity: 0; 
    transition: opacity 0.3s; 
    white-space: pre-wrap; 
    word-wrap: break-word; 
    max-width: 90vw; 
    max-height: 50vh; 
    overflow-y: auto; 
    direction: rtl; 
    text-align: right; 
    box-sizing: border-box;
    z-index: 25;
    border: 1px solid rgba(255,255,255,0.2);
}
.starMessage::-webkit-scrollbar { width: 3px; }
.starMessage::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }
.starMessage::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }
.starMessage::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }

:root {
    --control-bg: rgba(255, 255, 255, 0.1);
    --control-border: rgba(255, 255, 255, 0.3);
    --control-color: rgba(255, 255, 255, 0.8);
}

#fabButton {
    position: fixed;
    top: 15px; 
    right: 15px; 
    width: auto; 
    height: auto; 
    background: transparent; 
    color: #fff; 
    border: none; 
    font-size: 28px; 
    line-height: 1; 
    text-align: center;
    cursor: pointer;
    z-index: 50; 
    font-family: Arial, sans-serif; 
    display: block; 
    transition: transform 0.3s ease, color 0.2s;
    touch-action: manipulation;
    padding: 5px;
    border-radius: 0;
    box-shadow: none;
}
#fabButton:hover {
    color: #ffcc00; 
    transform: scale(1.2);
    background: transparent;
}
#fabButton:active,
#fabButton:focus {
    background: transparent;
    border: none;
    outline: none;
    box-shadow: none;
}

#navigateStarBtn {
    position: fixed;
    bottom: 80px;
    left: 15px;
    width: 75px; 
    height: 75px; 
    border-radius: 50%; 
    background: transparent; 
    border: none; 
    color: transparent; 
    font-size: 0; 
    text-align: center;
    cursor: pointer;
    z-index: 20;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
    transition: all 0.3s ease;
    display: block;
    touch-action: manipulation;
    background-image: url('spacecraft.png');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    filter: brightness(1);
}

#navigateStarBtn:hover {
    transform: scale(1.15);
    filter: brightness(1.3);
    box-shadow: 0 6px 20px rgba(0, 255, 255, 0.5);
}

#navigateStarBtn:active {
    transform: scale(0.9);
    filter: brightness(0.8);
}

/* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© - Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø¬ÙˆØ§Ù„ */
#userPanel {
    position: fixed;
    top: 0; 
    right: 0; 
    height: 100%; 
    width: 70vw;
    max-width: 250px;
    padding: 15px; 
    z-index: 45; 
    text-align: right;
    display: none; 
    flex-direction: column;
    align-items: flex-end;
    font-family: 'Cairo', sans-serif;
    background: rgba(0, 0, 0, 0.98); 
    backdrop-filter: blur(15px); 
    -webkit-backdrop-filter: blur(15px);
    border-left: 2px solid var(--control-border); 
    transform: translateX(100%);
    transition: transform 0.3s ease-out; 
    box-shadow: -4px 0 15px rgba(0, 0, 0, 0.8);
    overflow-y: auto;
    box-sizing: border-box;
}

#userPanel.open {
    transform: translateX(0);
}

/* ØªØ­ÙŠØ© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ */
#userGreeting {
    margin: 10px 0 20px 0; 
    color: #0f0; 
    font-weight: bold;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    max-width: 100%;
    order: 1; 
    font-size: 1.1em;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--control-border);
    width: 100%;
    text-align: center;
}

/* Ù‚Ø³Ù… Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
.message-type-section {
    width: 100%;
    margin: 15px 0;
    padding: 12px 0;
    border-bottom: 1px solid var(--control-border);
}

.message-type-section h4 {
    margin: 0 0 12px 0;
    color: #0f0;
    font-size: 15px;
    text-align: center;
}

.message-type-options {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
}

.message-type-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 13px;
    border: 1px solid transparent;
}

.message-type-option:hover {
    background: rgba(255, 255, 255, 0.1);
}

.message-type-option.active {
    background: #0f0;
    color: #000;
    font-weight: bold;
    border-color: #0f0;
}

.message-type-option .badge {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
    border-radius: 12px;
    padding: 2px 6px;
    font-size: 10px;
    min-width: 20px;
    text-align: center;
}

.message-type-option.active .badge {
    background: rgba(0, 0, 0, 0.3);
    color: #000;
}

/* Ù‚Ø³Ù… Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© */
.message-status-section {
    width: 100%;
    margin: 12px 0;
    padding: 10px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
}

.message-status-section h5 {
    margin: 0 0 8px 0;
    color: #ffa500;
    font-size: 13px;
    text-align: center;
}

.message-status-options {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.message-status-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 13px;
}

.message-status-option:hover {
    background: rgba(255, 255, 255, 0.1);
}

.message-status-option.active {
    background: #ffa500;
    color: #000;
    font-weight: bold;
}

/* Ø£Ø²Ø±Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
#userPanel button {
    background: var(--control-bg); 
    color: var(--control-color);
    border: 1px solid var(--control-border); 
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 8px;
    margin-right: 0px;
    font-size: 13px;
    order: 2; 
    width: 100%; 
    font-family: 'Cairo', sans-serif;
    transition: background 0.2s, border-color 0.2s;
    font-weight: 500;
    touch-action: manipulation;
}
#userPanel button:hover {
    background: rgba(255, 255, 255, 0.15); 
    border-color: #fff; 
    color: #fff;
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø© - Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø¬ÙˆØ§Ù„ */
#controlButtons {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    display: none;
    flex-direction: row;
    gap: 6px;
    z-index: 40;
    width: 95vw;
    max-width: 95vw;
    overflow-x: auto;
    scrollbar-width: none;
    white-space: nowrap;
    padding: 8px 10px;
    background: rgba(0, 0, 0, 0.85);
    border-radius: 12px;
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-sizing: border-box;
    -ms-overflow-style: none;
}

#controlButtons::-webkit-scrollbar {
    display: none;
}

.control-btn {
    padding: 10px 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-family: 'Cairo', sans-serif;
    font-size: 12px;
    font-weight: bold;
    transition: all 0.3s ease;
    opacity: 0.9;
    white-space: nowrap;
    flex-shrink: 0;
    display: inline-block;
    min-width: max-content;
    touch-action: manipulation;
}

.control-btn:hover {
    opacity: 1;
    transform: scale(1.05);
}

#editMessageControlBtn { background: #ffa500; color: #000; }
#pinMessageControlBtn { background: #009688; color: #fff; }
#likeControlBtn { background: #e91e63; color: #fff; }
#likersControlBtn { background: #9c27b0; color: #fff; }
#addFavoriteControlBtn { background: #4CAF50; color: #fff; }
#addFavoriteControlBtn.favorite { background: #f44336; color: #fff; }
#favoritesListControlBtn { background: #2196F3; color: #fff; }
#replyControlBtn { background: #FF9800; color: #fff; }
#deleteMessageControlBtn { background: #f44336; color: white; }

/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù‚Ù„ÙˆØ¨ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© */
.flying-hearts-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 100;
}

.flying-heart {
    position: absolute;
    font-size: 18px;
    opacity: 0.7;
    z-index: 100;
    pointer-events: none;
    animation: flyHeart 1.5s ease-out forwards;
}

@keyframes flyHeart {
    0% {
        transform: translate(0, 0) scale(1);
        opacity: 0.8;
    }
    100% {
        transform: translate(var(--tx), var(--ty)) scale(0.3);
        opacity: 0;
    }
}

#likersModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.95);
    padding: 20px;
    border-radius: 12px;
    display: none;
    z-index: 70;
    color: #fff;
    text-align: center;
    border: 1px solid #e91e63;
    font-family: 'Cairo', sans-serif;
    width: 90vw;
    max-width: 90vw;
    max-height: 70vh;
    overflow-y: auto;
    box-sizing: border-box;
}

#likersModal h3 {
    color: #e91e63;
    margin-top: 0;
    margin-bottom: 15px;
}

#likersList {
    text-align: right;
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
    background: rgba(255,255,255,0.05);
    border-radius: 6px;
}

#likersList div {
    padding: 8px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-family: 'IBM Plex Mono', monospace;
}

#closeLikersBtn {
    margin-top: 15px;
    padding: 10px 15px;
    background: #e91e63;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'Cairo', sans-serif;
    font-size: 14px;
}

/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯ */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 100;
    backdrop-filter: blur(8px);
}

.modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.95);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #0f0;
    width: 95vw;
    max-width: 95vw;
    max-height: 80vh;
    overflow-y: auto;
    font-family: 'Cairo', sans-serif;
    box-sizing: border-box;
}

.modal-content h3 {
    color: #0f0;
    text-align: center;
    margin-bottom: 15px;
}

#repliesList {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 15px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
}

.reply-item {
    padding: 10px;
    margin-bottom: 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    text-align: right;
}

.reply-author {
    color: #ffa500;
    font-weight: bold;
    margin-bottom: 5px;
}

.reply-text {
    color: #87CEEB;
    font-family: 'IBM Plex Mono', monospace;
}

#replyInput {
    width: 100%;
    min-height: 100px;
    margin-bottom: 15px;
    background: #111;
    color: #ffa500;
    border: 1px solid #555;
    border-radius: 6px;
    padding: 10px;
    resize: vertical;
    font-family: 'IBM Plex Mono', monospace;
    box-sizing: border-box;
    font-size: 16px;
}

.modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
}

.modal-buttons button {
    padding: 10px 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'Cairo', sans-serif;
    font-weight: bold;
    font-size: 14px;
    min-width: 100px;
}

#sendReplyBtn {
    background: #0f0;
    color: #000;
}

#closeReplyBtn {
    background: #888;
    color: #fff;
}

/* Ù†Ø§ÙØ°Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© */
#favoritesModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.95);
    padding: 20px;
    border-radius: 12px;
    display: none;
    z-index: 70;
    color: #fff;
    text-align: center;
    border: 1px solid #FFD700;
    font-family: 'Cairo', sans-serif;
    width: 90vw;
    max-width: 90vw;
    max-height: 70vh;
    overflow-y: auto;
    box-sizing: border-box;
}

#favoritesModal h3 {
    color: #FFD700;
    margin-top: 0;
    margin-bottom: 15px;
}

#favoritesList {
    text-align: right;
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
    background: rgba(255,255,255,0.05);
    border-radius: 6px;
}

#favoritesList div {
    padding: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-family: 'IBM Plex Mono', monospace;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.favorite-actions {
    display: flex;
    gap: 8px;
}

.remove-favorite-btn {
    background: #f44336;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 12px;
    font-family: 'Cairo', sans-serif;
}

#closeFavoritesBtn {
    margin-top: 15px;
    padding: 10px 15px;
    background: #FFD700;
    color: black;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'Cairo', sans-serif;
    font-size: 14px;
}

.control-btn.with-badge {
    position: relative;
}

.badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #e91e63;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ */
@media (max-width: 360px) {
    #controlButtons {
        padding: 6px 8px;
        gap: 4px;
    }
    
    .control-btn {
        padding: 8px 10px;
        font-size: 11px;
    }
    
    #fabButton {
        width: 45px;
        height: 45px;
        font-size: 18px;
        line-height: 45px;
    }
    
    #navigateStarBtn {
        width: 50px;
        height: 50px;
        font-size: 22px;
        line-height: 50px;
    }
    
    .starMessage {
        font-size: 15px;
        padding: 10px 12px;
    }
}

/* Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ */
* {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

input, textarea {
    -webkit-user-select: text;
    -khtml-user-select: text;
    -moz-user-select: text;
    -ms-user-select: text;
    user-select: text;
}

/* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ */
canvas {
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    image-rendering: pixelated;
}

</style>
</head>
<body>
<canvas id="c" touch-action="none"></canvas>

<!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù‚Ù„ÙˆØ¨ Ø§Ù„Ø·Ø§Ø¦Ø±Ø© -->
<div id="flyingHeartsContainer" class="flying-hearts-container"></div>

<button id="fabButton">âš™ï¸</button>
<button id="navigateStarBtn">ğŸ”</button>

<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø© -->
<div id="controlButtons">
    <button id="editMessageControlBtn" class="control-btn">ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
    <button id="pinMessageControlBtn" class="control-btn">ØªØ«Ø¨ÙŠØª Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
    <button id="deleteMessageControlBtn" class="control-btn">Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
    <button id="addFavoriteControlBtn" class="control-btn">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©</button>
    <button id="favoritesListControlBtn" class="control-btn">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©</button>
    <button id="replyControlBtn" class="control-btn with-badge">Ø§Ù„Ø±Ø¯ÙˆØ¯ <span class="badge" id="replyCount">0</span></button>
    <button id="likersControlBtn" class="control-btn">Ø§Ù„Ù…Ø¹Ø¬Ø¨ÙˆÙ† (0)</button>
    <button id="likeControlBtn" class="control-btn">Ø¬Ù…ÙŠÙ„Ø© â¤ï¸</button>
</div>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø§Ù„Ù…Ø­Ø³Ù†Ø© -->
<div id="userPanel">
    <!-- ØªØ­ÙŠØ© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ -->
    <div id="userGreeting">Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙÙŠ Ù‡Ù…Ø³Ø§Øª Ø§Ù„Ù†Ø¬ÙˆÙ…! âœ¨</div>
    
    <!-- Ù‚Ø³Ù… Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <div class="message-type-section">
        <h4>Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h4>
        <div class="message-type-options">
            <div class="message-type-option active" data-type="all">
                <span>ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
                <span class="badge" id="allMessagesCount">0</span>
            </div>
            
            <div class="message-type-option" data-type="favorites">
                <span>Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙØ¶Ù„Ø©</span>
                <span class="badge" id="favoritesMessagesCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- Ù‚Ø³Ù… Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© - ÙˆØ§Ø­Ø¯ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ -->
    <div class="message-status-section">
        <h5>Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h5>
        <div class="message-status-options">
            <div class="message-status-option active" data-status="all">
                <span>Ø§Ù„ÙƒÙ„</span>
            </div>
            <div class="message-status-option" data-status="read">
                <span>Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©</span>
            </div>
            <div class="message-status-option" data-status="unread">
                <span>ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©</span>
            </div>
        </div>
    </div>
</div>

<div id="messageModal">
  <div>ğŸŒŸ Ø§ÙƒØªØ¨ Ø´ÙŠØ¦Ø§ Ø±Ø§Ø¦Ø¹Ø§ </div>
  <input type="text" class="titleInput" id="titleInput" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙƒÙ„Ù…Ø© ÙˆØ§Ø­Ø¯Ø© (15 Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)"> 
  <textarea id="messageInput" placeholder="Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©"></textarea><br/>
  <button id="sendBtn">Ø­ÙØ¸</button>
  <button class="cancel" id="cancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<div id="likersModal">
    <h3>Ø§Ù„Ù…Ø¹Ø¬Ø¨ÙˆÙ† Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</h3>
    <div id="likersList"></div>
    <button id="closeLikersBtn">Ø¥ØºÙ„Ø§Ù‚</button>
</div>

<div id="favoritesModal">
    <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©</h3>
    <div id="favoritesList"></div>
    <button id="closeFavoritesBtn">Ø¥ØºÙ„Ø§Ù‚</button>
</div>

<div id="replyModal" class="modal">
    <div class="modal-content">
        <h3>Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</h3>
        <div id="repliesList"></div>
        <textarea id="replyInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..."></textarea>
        <div class="modal-buttons">
            <button id="sendReplyBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯</button>
            <button id="closeReplyBtn">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, updateDoc, setDoc, getDoc, collection, query, where, getDocs, deleteField, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  
const moonImage = new Image();
moonImage.src = 'moon.png';
let moonImageLoaded = false;

moonImage.onload = function() {
    moonImageLoaded = true;
    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ù‚Ù…Ø± Ø¨Ù†Ø¬Ø§Ø­');
};

moonImage.onerror = function() {
    console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ù‚Ù…Ø±');
};

  function simpleUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
      });
  }

  function getDeviceUUID() {
      let deviceId = localStorage.getItem('deviceUUID');
      if (!deviceId) {
          deviceId = simpleUUID();
          localStorage.setItem('deviceUUID', deviceId);
      }
      return deviceId;
  }
  
  const DEVICE_UUID = getDeviceUUID();
  
  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
  let currentUser = {
    uid: `guest_${DEVICE_UUID}`,
    displayName: 'Ø²Ø§Ø¦Ø±',
    readStarIds: {},
    favorites: []
  };

  function saveUserToLocal() {
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
  }
  
  function loadUserFromLocal() {
      const saved = localStorage.getItem('currentUser');
      if (saved) {
          currentUser = JSON.parse(saved);
      }
      return currentUser;
  }

  const firebaseConfig = {
    apiKey: "AIzaSyCxNgh_8Q2qSpoPlBZpLgbeXqmedXXNkE8",
    authDomain: "night-star-d716a.firebaseapp.com",
    projectId: "night-star-d716a",
    storageBucket: "night-star-d716a.firebasestorage.app",
    messagingSenderId: "246582207525",
    appId: "1:246582207525:web:5808283c37060d6bc68bcc"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  
  const MESSAGES_COLLECTION = collection(db, "messages");
  const LIKES_COLLECTION = collection(db, "likes");
  const FAVORITES_COLLECTION = collection(db, "favorites");
  const REPLIES_COLLECTION = collection(db, "replies");

  let cachedMessages = new Map();
  let lastTouchedStar = null;  
  
// ğŸ”¥ Real-time Listener Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
import { onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Ø¯Ø§Ù„Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
function startMessagesListener() {
    try {
        console.log("ğŸ¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ...");
        
        onSnapshot(MESSAGES_COLLECTION, (snapshot) => {
            console.log("ğŸ”„ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            
            snapshot.docChanges().forEach((change) => {
                const starId = change.doc.id;
                const messageData = change.doc.data();
                
                if (change.type === 'added' || change.type === 'modified') {
                    cachedMessages.set(starId, messageData);
                    console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${starId}`);
                    
                    bindMessagesToStars(cachedMessages);
                    
                } else if (change.type === 'removed') {
                    cachedMessages.delete(starId);
                    console.log(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${starId}`);
                    
                    bindMessagesToStars(cachedMessages);
                }
            });
            
            updateMessageCounts();
        });
        
        console.log("âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ");
        
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª:", error);
    }
}

// ğŸ”¥ Real-time Listener Ù„Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª
function startLikesListener() {
    try {
        onSnapshot(LIKES_COLLECTION, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const starId = change.doc.id;
                const likesData = change.doc.data();
                
                cachedLikes.set(starId, likesData);
                
                if (lastTouchedStar && lastTouchedStar.id.toString() === starId) {
                    updateLikersButton(starId);
                }
            });
        });
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª:", error);
    }
}

// ğŸ”¥ Real-time Listener Ù„Ù„Ø±Ø¯ÙˆØ¯
function startRepliesListener() {
    try {
        onSnapshot(REPLIES_COLLECTION, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const starId = change.doc.id;
                
                if (lastTouchedStar && lastTouchedStar.id.toString() === starId) {
                    updateReplyCount();
                }
            });
        });
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø¯ÙˆØ¯:", error);
    }
}

  const userPanel = document.getElementById('userPanel');
  const userGreeting = document.getElementById('userGreeting');
  
  const fabButton = document.getElementById('fabButton');
  const navigateStarBtn = document.getElementById('navigateStarBtn');

  const allMessagesCount = document.getElementById('allMessagesCount');
  const favoritesMessagesCount = document.getElementById('favoritesMessagesCount');

  const controlButtons = document.getElementById('controlButtons');
  const editMessageControlBtn = document.getElementById('editMessageControlBtn');
  const pinMessageControlBtn = document.getElementById('pinMessageControlBtn');
  const deleteMessageControlBtn = document.getElementById('deleteMessageControlBtn');
  const likeControlBtn = document.getElementById('likeControlBtn');
  const likersControlBtn = document.getElementById('likersControlBtn');
  const addFavoriteControlBtn = document.getElementById('addFavoriteControlBtn');
  const favoritesListControlBtn = document.getElementById('favoritesListControlBtn');
  const replyControlBtn = document.getElementById('replyControlBtn');
  const replyCount = document.getElementById('replyCount');

  const likersModal = document.getElementById('likersModal');
  const likersList = document.getElementById('likersList');
  const closeLikersBtn = document.getElementById('closeLikersBtn');

  const favoritesModal = document.getElementById('favoritesModal');
  const favoritesList = document.getElementById('favoritesList');
  const closeFavoritesBtn = document.getElementById('closeFavoritesBtn');

  const messageModal=document.getElementById('messageModal');
  const messageInput=document.getElementById('messageInput');
  const titleInput=document.getElementById('titleInput'); 
  const sendBtn=document.getElementById('sendBtn');
  const cancelBtn=document.getElementById('cancelBtn');
  let activeStar=null;

  let navigationMode = 'all';
  let messageStatusFilter = 'all';

  let cachedLikes = new Map();
  
  async function loadAndCacheLikes() {
      try {
          const querySnapshot = await getDocs(LIKES_COLLECTION);
          cachedLikes.clear();
          querySnapshot.forEach((doc) => {
              cachedLikes.set(doc.id, doc.data());
          });
          console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª. Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª ÙÙŠ Ø§Ù„ÙƒØ§Ø´: ${cachedLikes.size}`);
      } catch (error) {
          console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ù…Ù† Firebase:", error);
      }
  }
  
  async function toggleLike(starId) {
      if (!lastTouchedStar) return;
      
      const starIdStr = starId.toString();
      const userId = currentUser.uid;
      
      try {
          const starLikes = cachedLikes.get(starIdStr) || {};
          
          if (starLikes[userId]) {
              delete starLikes[userId];
              console.log(`âŒ ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø¥Ø¹Ø¬Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${userId} Ø¨Ø§Ù„Ø±Ø³Ø§Ù„Ø© ${starIdStr}`);
          } else {
              starLikes[userId] = {
                  username: currentUser.displayName,
                  timestamp: new Date().toISOString()
              };
              console.log(`â¤ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø¬Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${userId} Ø¨Ø§Ù„Ø±Ø³Ø§Ù„Ø© ${starIdStr}`);
              
              createMultipleHearts();
          }
          
          await setDoc(doc(LIKES_COLLECTION, starIdStr), starLikes);
          cachedLikes.set(starIdStr, starLikes);
          
          updateLikersButton(starIdStr);
          
      } catch (error) {
          console.error("âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨:", error);
      }
  }
  
  function createMultipleHearts() {
      const container = document.getElementById('flyingHeartsContainer');
      const heartCount = 8;
      
      for (let i = 0; i < heartCount; i++) {
          setTimeout(() => {
              createFlyingHeart();
          }, i * 100);
      }
  }
  
  function createFlyingHeart() {
      const heart = document.createElement('div');
      heart.className = 'flying-heart';
      heart.innerHTML = 'â¤ï¸';
      
      const canvasRect = canvas.getBoundingClientRect();
      const star = lastTouchedStar;
      const cx = canvas.width/2, cy = canvas.height/2;
      const starX = (star.x - camera.x) + cx;
      const starY = (star.y - camera.y) + cy;
      
      heart.style.left = (canvasRect.left + starX/DPR) + 'px';
      heart.style.top = (canvasRect.top + starY/DPR) + 'px';
      
      const tx = (Math.random() - 0.5) * 200;
      const ty = -100 - Math.random() * 100;
      
      heart.style.setProperty('--tx', `${tx}px`);
      heart.style.setProperty('--ty', `${ty}px`);
      
      document.getElementById('flyingHeartsContainer').appendChild(heart);
      
      setTimeout(() => {
          if (heart.parentNode) {
              heart.parentNode.removeChild(heart);
          }
      }, 1500);
  }
  
  function updateLikersButton(starIdStr) {
      if (!starIdStr || !cachedLikes.get(starIdStr)) {
          likersControlBtn.innerText = `Ø§Ù„Ù…Ø¹Ø¬Ø¨ÙˆÙ† (0)`;
          return;
      }
      
      const likesCount = Object.keys(cachedLikes.get(starIdStr)).length;
      likersControlBtn.innerText = `Ø§Ù„Ù…Ø¹Ø¬Ø¨ÙˆÙ† (${likesCount})`;
  }
  
  async function showLikersModal(starIdStr) {
      if (!starIdStr || !cachedLikes.get(starIdStr)) {
          likersList.innerHTML = '<div>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø¬Ø¨ÙŠÙ† Ø¨Ø¹Ø¯</div>';
      } else {
          const starLikes = cachedLikes.get(starIdStr);
          const likersHTML = Object.values(starLikes)
              .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
              .map(like => `<div>${like.username} - ${new Date(like.timestamp).toLocaleString('ar-EG')}</div>`)
              .join('');
          likersList.innerHTML = likersHTML;
      }
      
      likersModal.style.display = 'block';
  }

  function updatePinButtonText(isPinned) {
      pinMessageControlBtn.innerText = isPinned ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª âŒ' : 'ØªØ«Ø¨ÙŠØª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ğŸ“Œ';
  }

  function toggleControlButtons(show) {
    if (show && lastTouchedStar && lastTouchedStar.hasMessage) {
        controlButtons.style.display = 'flex';
        updateLikersButton(lastTouchedStar.id.toString());
        
        const existingDiv = document.querySelector(`.starMessage[data-star-id="${lastTouchedStar.id}"]`);
        const isPinned = existingDiv && existingDiv.classList.contains('pinned');
        updatePinButtonText(isPinned);
        
        updateFavoriteButtonState();
        updateReplyCount();
        
        replyControlBtn.style.display = 'block';
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ ØµØ§Ø­Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        const isOwner = lastTouchedStar.uid === currentUser.uid;
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù ÙÙ‚Ø· Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        deleteMessageControlBtn.style.display = isOwner ? 'inline-block' : 'none';
        editMessageControlBtn.style.display = isOwner ? 'inline-block' : 'none';
        
        addFavoriteControlBtn.style.display = 'block';
    } else {
        controlButtons.style.display = 'none';
    }
}

async function updateReplyCount() {
    if (!lastTouchedStar) return;
    
    try {
        const replies = await loadReplies(lastTouchedStar.id.toString());
        replyCount.innerText = replies.length;
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯:", error);
        replyCount.innerText = "0";
    }
}

function updateFavoriteButtonState() {
    if (!lastTouchedStar || !lastTouchedStar.uid) {
        addFavoriteControlBtn.style.display = 'none';
        return;
    }
    
    addFavoriteControlBtn.style.display = 'block';
    
    const isFavorite = currentUser.favorites.includes(lastTouchedStar.id);
    
    if (isFavorite) {
        addFavoriteControlBtn.innerText = 'Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©';
        addFavoriteControlBtn.classList.add('favorite');
    } else {
        addFavoriteControlBtn.innerText = 'Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©';
        addFavoriteControlBtn.classList.remove('favorite');
    }
}

addFavoriteControlBtn.onclick = async () => {
    if (!lastTouchedStar) {
        showError("ÙŠØ±Ø¬Ù‰ Ù„Ù…Ø³ Ù†Ø¬Ù…Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹.");
        return;
    }
    
    const starId = lastTouchedStar.id.toString();
    const starTitle = lastTouchedStar.title || 'Ø±Ø³Ø§Ù„Ø©';
    
    try {
        const starIdNum = parseInt(starId);
        const isAlreadyFavorite = currentUser.favorites.includes(starIdNum);
        
        if (isAlreadyFavorite) {
            // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©
            currentUser.favorites = currentUser.favorites.filter(id => id !== starIdNum);
            addFavoriteControlBtn.innerText = 'Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©';
            addFavoriteControlBtn.classList.remove('favorite');
            showSuccess(`ØªÙ… Ø¥Ø²Ø§Ù„Ø© ${starTitle} Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©.`);
        } else {
            // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©
            currentUser.favorites.push(starIdNum);
            addFavoriteControlBtn.innerText = 'Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©';
            addFavoriteControlBtn.classList.add('favorite');
            showSuccess(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${starTitle} Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©.`);
        }
        
        // Ø­ÙØ¸ ÙÙŠ localStorage Ø£ÙˆÙ„Ø§Ù‹ (Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙŠØ¹Ù…Ù„)
        saveUserToLocal();
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase (Ø¥Ø°Ø§ ÙØ´Ù„ØŒ Ù†Ø³ØªÙ…Ø± Ù…Ø¹ localStorage)
        try {
            await setDoc(doc(FAVORITES_COLLECTION, DEVICE_UUID), {
                favorites: currentUser.favorites,
                updatedAt: new Date().toISOString(),
                userName: currentUser.displayName
            });
            console.log(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙØ¶Ù„Ø© ÙÙŠ Firebase`);
        } catch (firebaseError) {
            console.warn("âš ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ localStorage ÙÙ‚Ø· Ø¨Ø³Ø¨Ø¨:", firebaseError.message);
        }
        
        updateMessageCounts();
        
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©:", error);
        console.error("ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:", error.message, error.code);
        
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø£ÙŠ Ø®Ø·Ø£ØŒ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ localStorage ÙÙ‚Ø·
        showSuccess(isAlreadyFavorite ? 
            `ØªÙ… Ø¥Ø²Ø§Ù„Ø© ${starTitle} Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© (Ù…Ø­Ù„ÙŠØ§Ù‹).` : 
            `ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${starTitle} Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© (Ù…Ø­Ù„ÙŠØ§Ù‹).`
        );
        updateMessageCounts();
    }
};

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©
deleteMessageControlBtn.onclick = async () => {
    if (!lastTouchedStar) {
        showError("ÙŠØ±Ø¬Ù‰ Ù„Ù…Ø³ Ù†Ø¬Ù…Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹.");
        return;
    }
    
    const starId = lastTouchedStar.id.toString();
    const starTitle = lastTouchedStar.title || 'Ø±Ø³Ø§Ù„Ø©';
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ ØµØ§Ø­Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    if (lastTouchedStar.uid !== currentUser.uid) {
        showError("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© Ù„Ù… ØªÙƒØªØ¨Ù‡Ø§.");
        return;
    }
    
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© "${starTitle}"ØŸ`)) {
        return;
    }
    
    try {
        // Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Firebase
        await deleteDoc(doc(MESSAGES_COLLECTION, starId));
        console.log(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${starId}`);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ
        cachedMessages.delete(starId);
        bindMessagesToStars(cachedMessages);
        
        // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
        toggleControlButtons(false);
        
        showSuccess(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© "${starTitle}" Ø¨Ù†Ø¬Ø§Ø­.`);
        
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©:", error);
        showError("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.");
    }
};

// ğŸ”¥ Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
editMessageControlBtn.onclick = async () => {
    if (!lastTouchedStar) {
        showError("ÙŠØ±Ø¬Ù‰ Ù„Ù…Ø³ Ù†Ø¬Ù…Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹.");
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ ØµØ§Ø­Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    if (lastTouchedStar.uid !== currentUser.uid) {
        showError("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© Ù„Ù… ØªÙƒØªØ¨Ù‡Ø§.");
        return;
    }
    
    activeStar = lastTouchedStar;
    messageInput.value = lastTouchedStar.message || "";
    titleInput.value = lastTouchedStar.title || "";
    messageModal.style.display = "block";
    
    setTimeout(() => titleInput.focus(), 10);
};

pinMessageControlBtn.onclick = () => {
    if (!lastTouchedStar) {
        showError("ÙŠØ±Ø¬Ù‰ Ù„Ù…Ø³ Ù†Ø¬Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹.");
        return;
    }

    const star = lastTouchedStar;

    if (!star.hasMessage) {
          showError("Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø¬Ù…Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ù„ØªØ«Ø¨ÙŠØªÙ‡Ø§.");
          return;
    }
    
    let alreadyPinned = false;
    document.querySelectorAll('.starMessage.pinned').forEach(div => {
        const pinnedStarId = parseInt(div.dataset.starId);
        if (pinnedStarId !== star.id) {
            div.classList.remove('pinned');
            const oldStar = stars.find(s => s.id === pinnedStarId);
            if (oldStar) {
                hideStarMessageDiv(div, oldStar);  
            } else {
                div.remove();
            }
        } else {
           alreadyPinned = true;
        }
    });
    
    let existingDiv = document.querySelector(`.starMessage[data-star-id="${star.id}"]`);
    
    if (!existingDiv) {
        showStarMessage(star);
        existingDiv = document.querySelector(`.starMessage[data-star-id="${star.id}"]`);
    }
    
    if (existingDiv) {
        const isPinned = existingDiv.classList.toggle('pinned');
        
        updatePinButtonText(isPinned);
        
        if (isPinned) {
            clearTimeout(star.hideTimeout);  
        } else {
            clearTimeout(star.hideTimeout);
            star.hideTimeout = setTimeout(() => hideStarMessageDiv(existingDiv, star), 5000);  
        }
    }
};

likeControlBtn.onclick = () => {
    if (!lastTouchedStar) {
        showError("ÙŠØ±Ø¬Ù‰ Ù„Ù…Ø³ Ù†Ø¬Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹.");
        return;
    }
    
    if (!lastTouchedStar.hasMessage) {
        showError("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ Ø¨Ù†Ø¬Ù…Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø©.");
        return;
    }
    
    toggleLike(lastTouchedStar.id);
};

likersControlBtn.onclick = () => {
    if (!lastTouchedStar) {
        showError("ÙŠØ±Ø¬Ù‰ Ù„Ù…Ø³ Ù†Ø¬Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹.");
        return;
    }
    
    if (!lastTouchedStar.hasMessage) {
        showError("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø¬Ø¨ÙŠÙ† Ø¨Ù†Ø¬Ù…Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø©.");
        return;
    }
    
    showLikersModal(lastTouchedStar.id.toString());
};

favoritesListControlBtn.onclick = async () => {
    await showFavoritesModal();
};

replyControlBtn.onclick = () => {
    if (!lastTouchedStar) {
        showError("ÙŠØ±Ø¬Ù‰ Ù„Ù…Ø³ Ù†Ø¬Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹.");
        return;
    }
    
    if (!lastTouchedStar.hasMessage) {
        showError("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ù†Ø¬Ù…Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø©.");
        return;
    }
    
    showReplyModal(lastTouchedStar.id.toString());
};

let isPanelOpen = false;

fabButton.onclick = (e) => {
    e.stopPropagation();
    isPanelOpen = !isPanelOpen;
    if (isPanelOpen) {
        userPanel.classList.add('open');
        fabButton.innerText = 'âœ–ï¸';
    } else {
        userPanel.classList.remove('open');
        fabButton.innerText = 'âš™ï¸';
    }
};

function closePanel() {
    if (isPanelOpen) {
        userPanel.classList.remove('open');
        fabButton.innerText = 'âš™ï¸';
        isPanelOpen = false;
    }
}

function setupMessageTypeOptions() {
    const messageTypeOptions = document.querySelectorAll('.message-type-option');
    const messageStatusOptions = document.querySelectorAll('.message-status-option');
    
    messageTypeOptions.forEach(option => {
        option.addEventListener('click', (e) => {
            const type = e.currentTarget.dataset.type;
            
            messageTypeOptions.forEach(opt => {
                opt.classList.remove('active');
            });
            e.currentTarget.classList.add('active');
            
            navigationMode = type;
            resetStarNavigation();
            console.log(`âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙˆØ¶Ø¹ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¥Ù„Ù‰: ${type}`);
        });
    });
    
    messageStatusOptions.forEach(option => {
        option.addEventListener('click', (e) => {
            const status = e.currentTarget.dataset.status;
            
            e.currentTarget.closest('.message-status-options').querySelectorAll('.message-status-option').forEach(opt => {
                opt.classList.remove('active');
            });
            e.currentTarget.classList.add('active');
            
            messageStatusFilter = status;
            resetStarNavigation();
            console.log(`âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙÙ„ØªØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¥Ù„Ù‰: ${status}`);
        });
    });
}

async function loadFavoritesList() {
    try {
        // Ø£ÙˆÙ„Ø§Ù‹ Ù†Ø­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase
        const favoriteDoc = await getDoc(doc(FAVORITES_COLLECTION, currentUser.uid));
        if (favoriteDoc.exists()) {
            currentUser.favorites = favoriteDoc.data().favorites || [];
            saveUserToLocal();
            console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù…Ù† Firebase");
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ ÙÙŠ FirebaseØŒ Ù†Ø³ØªØ®Ø¯Ù… localStorage
            console.log("â„¹ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù…Ù† localStorage");
        }
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù…Ù† FirebaseØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… localStorage:", error);
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ localStorage Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
function cleanupFavorites() {
    const originalLength = currentUser.favorites.length;
    
    // ØªØµÙÙŠØ© Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¬ÙˆÙ… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙ‚Ø·
    currentUser.favorites = currentUser.favorites.filter(starId => {
        const star = stars.find(s => s.id === starId);
        return star && star.hasMessage; // Ø¥Ø±Ø¬Ø§Ø¹ true ÙÙ‚Ø· Ø¥Ø°Ø§ Ø§Ù„Ù†Ø¬Ù…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆÙ„Ù‡Ø§ Ø±Ø³Ø§Ù„Ø©
    });
    
    const cleanedLength = currentUser.favorites.length;
    
    if (cleanedLength < originalLength) {
        console.log(`ğŸ§¹ ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙØ¶Ù„Ø©: ${originalLength - cleanedLength} Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ØªÙ…Øª Ø¥Ø²Ø§Ù„ØªÙ‡Ø§`);
        saveUserToLocal();
        
        // ØªØ­Ø¯ÙŠØ« Firebase Ø£ÙŠØ¶Ø§Ù‹ Ø¥Ø°Ø§ Ø£Ù…ÙƒÙ†
        try {
            setDoc(doc(FAVORITES_COLLECTION, currentUser.uid), {
                favorites: currentUser.favorites,
                updatedAt: new Date().toISOString()
            });
        } catch (error) {
            console.log("âš ï¸ ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙÙŠ localStorage ÙÙ‚Ø·");
        }
    }
    
    return originalLength - cleanedLength;
}

async function showFavoritesModal() {
    try {
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙØ¶Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        const removedCount = cleanupFavorites();
        
        const favoritesHTML = [];
        
        if (currentUser.favorites.length === 0) {
            if (removedCount > 0) {
                favoritesList.innerHTML = `<div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„Ù…ÙØ¶Ù„Ø©<br><small>ØªÙ… ØªÙ†Ø¸ÙŠÙ ${removedCount} Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</small></div>`;
            } else {
                favoritesList.innerHTML = '<div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„Ù…ÙØ¶Ù„Ø©</div>';
            }
        } else {
            for (const starId of currentUser.favorites) {
                const star = stars.find(s => s.id === starId);
                if (star && star.hasMessage) {
                    favoritesHTML.push(`
                        <div>
                            <strong>${star.title || 'Ø±Ø³Ø§Ù„Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</strong><br>
                            <small>${star.message.substring(0, 50)}${star.message.length > 50 ? '...' : ''}</small>
                            <div class="favorite-actions">
                                <button class="remove-favorite-btn" data-id="${starId}">Ø¥Ø²Ø§Ù„Ø©</button>
                            </div>
                        </div>
                    `);
                }
            }
            
            favoritesList.innerHTML = favoritesHTML.join('');
            
            // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¥Ø°Ø§ ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø¨Ø¹Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            if (removedCount > 0) {
                favoritesList.innerHTML = `
                    <div style="background: #333; padding: 10px; border-radius: 5px; margin-bottom: 10px; text-align: center;">
                        <small>ØªÙ… ØªÙ†Ø¸ÙŠÙ ${removedCount} Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</small>
                    </div>
                    ${favoritesList.innerHTML}
                `;
            }
            
            document.querySelectorAll('.remove-favorite-btn').forEach(btn => {
                btn.onclick = async (e) => {
                    const starId = e.target.dataset.id;
                    await removeFavorite(starId);
                };
            });
        }
        
        favoritesModal.style.display = 'block';
        
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©:", error);
        showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©.");
    }
}

async function removeFavorite(starId) {
    try {
        // ØªØ­ÙˆÙŠÙ„ starId Ø¥Ù„Ù‰ Ø±Ù‚Ù…
        const starIdNum = parseInt(starId);
        
        // ØªØµÙÙŠØ© Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù…Ø¹ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© ÙƒØ£Ø±Ù‚Ø§Ù…
        currentUser.favorites = currentUser.favorites.filter(id => id !== starIdNum);
        
        // Ø­ÙØ¸ ÙÙŠ localStorage Ø£ÙˆÙ„Ø§Ù‹
        saveUserToLocal();
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase
        try {
            await setDoc(doc(FAVORITES_COLLECTION, currentUser.uid), {
                favorites: currentUser.favorites,
                updatedAt: new Date().toISOString(),
                userName: currentUser.displayName
            });
        } catch (firebaseError) {
            console.warn("âš ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ localStorage ÙÙ‚Ø· Ø¨Ø³Ø¨Ø¨:", firebaseError.message);
        }
        
        await showFavoritesModal();
        
        if (lastTouchedStar && lastTouchedStar.id.toString() === starId) {
            updateFavoriteButtonState();
        }
        
        updateMessageCounts();
        
        showSuccess("ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©.");
        
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©:", error);
        
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ localStorage
        showSuccess("ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø© (Ù…Ø­Ù„ÙŠØ§Ù‹).");
        updateMessageCounts();
    }
}

closeFavoritesBtn.onclick = () => {
    favoritesModal.style.display = 'none';
};

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
async function loadAllMessagesOnce() {
    try {
        console.log("ğŸš€ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©...");
        const querySnapshot = await getDocs(MESSAGES_COLLECTION);
        
        cachedMessages.clear();
        querySnapshot.forEach((doc) => {
            cachedMessages.set(doc.id, doc.data());
        });
        
        console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${cachedMessages.size} Ø±Ø³Ø§Ù„Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©`);
        bindMessagesToStars(cachedMessages);
        
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©:", error);
    }
}

async function updateUI() { 
    loadUserFromLocal();
    
    // ğŸ”¥ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
    await loadAllMessagesOnce();
    await loadAndCacheLikes();
    await loadFavoritesList();
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    cleanupFavorites();
    
    startMessagesListener();
    startLikesListener();
    startRepliesListener();
    
    resetStarNavigation();
    
    fabButton.style.display = 'block';  
    userPanel.style.display = 'flex';
    navigateStarBtn.style.display = 'block';
    controlButtons.style.display = 'none';
    
    setupMessageTypeOptions();
    
    updateMessageCounts();
}

closeLikersBtn.onclick = () => {
    likersModal.style.display = 'none';
};

function hideStarMessageDiv(div, star) {
    if (div && div.classList && !div.classList.contains('pinned')) {
        div.style.opacity = 0;
        setTimeout(() => {  
            div.remove();  
            star.showing = false;  
            
            const anyMessageOpen = stars.some(s => s.showing && s.hasMessage);
            if (!anyMessageOpen) {
                fabButton.style.display = 'block';
            }
            
        }, 300);
        updatePinButtonText(false);
        document.removeEventListener('pointerdown', div.outsideClick);
        
        if (parseInt(div.dataset.starId) === lastTouchedStar?.id) {
            toggleControlButtons(false);
        }
    }
}

async function loadReplies(starId) {
    try {
        const replyDoc = await getDoc(doc(REPLIES_COLLECTION, starId));
        return replyDoc.exists() ? replyDoc.data().replies || [] : [];
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¯ÙˆØ¯:", error);
        return [];
    }
}

async function saveReply(starId, replyText) {    
    try {
        const replyDoc = await getDoc(doc(REPLIES_COLLECTION, starId));
        const existingReplies = replyDoc.exists() ? replyDoc.data().replies || [] : [];
        
        const newReply = {
            id: `reply_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            text: replyText,
            author: currentUser.displayName,
            authorId: currentUser.uid,
            timestamp: new Date().toISOString()
        };
        
        const updatedReplies = [...existingReplies, newReply];
        
        await setDoc(doc(REPLIES_COLLECTION, starId), {
            replies: updatedReplies,
            lastUpdated: new Date().toISOString()
        });
        
        return newReply;
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø±Ø¯:", error);
        throw error;
    }
}

async function showReplyModal(starId) {
    if (!starId) return;
    
    try {
        const replies = await loadReplies(starId);
        
        if (replies.length === 0) {
            repliesList.innerHTML = '<div class="reply-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø¯ÙˆØ¯ Ø¨Ø¹Ø¯</div>';
        } else {
repliesList.innerHTML = replies
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
    .map(reply => `
        <div class="reply-item">
            <div class="reply-author">${reply.author}</div>
            <div class="reply-text">${reply.text}</div>
            <div style="font-size: 12px; color: #888; margin-top: 5px;">
                ${formatArabicDate(reply.timestamp)}
            </div>
        </div>
    `).join('');
        }
        
        replyInput.value = '';
        
        replyModal.style.display = 'block';
        
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¯ÙˆØ¯:", error);
        showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¯ÙˆØ¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.");
    }
}

sendReplyBtn.onclick = async () => {
    const replyText = replyInput.value.trim();
    
    if (!replyText) {
        showError("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø±Ø¯ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.");
        return;
    }
    
    if (!lastTouchedStar) {
        showError("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§.");
        return;
    }
    
    try {
        sendReplyBtn.disabled = true;
        sendReplyBtn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
        
        await saveReply(lastTouchedStar.id.toString(), replyText);
        
        await showReplyModal(lastTouchedStar.id.toString());
        
        await updateReplyCount();
        
        sendReplyBtn.disabled = false;
        sendReplyBtn.innerText = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯';
        
    } catch (error) {
        showError("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.");
        sendReplyBtn.disabled = false;
        sendReplyBtn.innerText = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯';
    }
};

closeReplyBtn.onclick = () => {
    replyModal.style.display = 'none';
};

replyModal.onclick = (e) => {
    if (e.target === replyModal) {
        replyModal.style.display = 'none';
    }
};

const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
let DPR=window.devicePixelRatio||1;
function resize(){canvas.width=innerWidth*DPR;canvas.height=innerHeight*DPR;canvas.style.width=innerWidth+'px';canvas.style.height=innerHeight+'px';}
window.addEventListener('resize',resize);resize();

const CELL_SIZE=800;
let starDensity=0.5;
const camera={x:0,y:0,tx:0,ty:0};
const stars=[];
const generatedCells=new Set();
let starId=0;

let isAutoMoving = false;

function cellKey(cx,cy){return cx+','+cy;}

function generateCell(cx,cy){
  const key=cellKey(cx,cy);
  if(generatedCells.has(key))return;
  generatedCells.add(key);
  let seed=(cx*374761393+cy*668265263)>>>0;
  function rnd(){seed=(seed*1664525+1013904223)>>>0;return seed/4294967296;}
  const baseCount=Math.floor(80*starDensity);
  const count=baseCount+Math.floor(rnd()*baseCount);
  const minDistance=60*DPR;
  
  for(let i=0;i<count;i++){
    let tries=0,ok=false,wx,wy;
    while(tries<100 && !ok){
      wx=cx*CELL_SIZE+rnd()*CELL_SIZE;
      wy=cy*CELL_SIZE+rnd()*CELL_SIZE;
      ok=true;
      for(const s of stars){
        const dx=s.x-wx,dy=s.y-wy;
        if(Math.abs(dx)<minDistance && Math.abs(dy)<minDistance){ok=false;break;}
      }
      tries++;
    }
    if(ok){
      const isMoon = starId === 0;
      
      const normalSize = Math.max(0.6, rnd()*2.5)*DPR;
      const moonSize = 60 * DPR;
      const size = isMoon ? moonSize : normalSize;
      
      const brightness=0.4+rnd()*0.6;
      const pulseSpeed=0.5+rnd()*1.5;
      const phase=rnd()*Math.PI*2;
      
      stars.push({
        id: starId++,
        x: wx,
        y: wy, 
        size,
        brightness,
        pulseSpeed,
        phase, 
        message: null,
        hasMessage: false,
        title: null,
        opened: false,
        showing: false, 
        docId: null, 
        uid: null, 
        isPinned: false,
        isMoon: isMoon
      });
    }
  }
}

function generateNearby(){
  const camCellX=Math.floor(camera.x/CELL_SIZE);
  const camCellY=Math.floor(camera.y/CELL_SIZE);
  for(let dx=-2;dx<=2;dx++){
    for(let dy=-2;dy<=2;dy++){
      generateCell(camCellX+dx,camCellY+dy);
    }
  }
}

function drawMessageConnections(time) {
    const w = canvas.width, h = canvas.height;
    const cx = w / 2, cy = h / 2;
    const canvasRect = canvas.getBoundingClientRect();
    
    const messageDivs = document.querySelectorAll('.starMessage');
    
    messageDivs.forEach(div => {
        if (div.style.opacity === '0' || div.style.display === 'none') return;

        const starId = parseInt(div.dataset.starId);
        const star = stars.find(s => s.id === starId);

        if (star) {
            const star_sx = (star.x - camera.x) + cx;
            const star_sy = (star.y - camera.y) + cy;
            
            const divRect = div.getBoundingClientRect();
            const div_center_x = (divRect.left + divRect.width / 2 - canvasRect.left) * DPR;
            const div_center_y = (divRect.top + divRect.height / 2 - canvasRect.top) * DPR;

            const pulse = Math.sin(time / 400) * 0.2 + 0.8;
            const alpha = parseFloat(div.style.opacity || 1) * pulse * 0.6;
            
            ctx.beginPath();
            ctx.moveTo(star_sx, star_sy);
            ctx.lineTo(div_center_x, div_center_y);
            ctx.strokeStyle = `rgba(135, 206, 235, ${alpha * 0.2})`;
            ctx.lineWidth = 4 * DPR;
            ctx.setLineDash([4 * DPR, 4 * DPR]);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(star_sx, star_sy);
            ctx.lineTo(div_center_x, div_center_y);
            ctx.strokeStyle = `rgba(135, 206, 235, ${alpha})`;
            ctx.lineWidth = 1.5 * DPR;
            ctx.setLineDash([4 * DPR, 4 * DPR]);
            ctx.stroke();
            
            ctx.setLineDash([]); 
        }
    });
}

function draw(time){
  const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle='#000'; ctx.fillRect(0,0,w,h);
  const cx=w/2,cy=h/2;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.font=12*DPR+'px monospace';
  
  drawMessageConnections(time); 

  for(const s of stars){
    const sx=(s.x-camera.x)+cx;
    const sy=(s.y-camera.y)+cy;
    if(sx<-50||sx>w+50||sy<-50||sy>h+50)continue;
    
    if(s.id === 0 && moonImageLoaded) {
        const moonSize = 120 * DPR;
        ctx.drawImage(moonImage, sx - moonSize/2, sy - moonSize/2, moonSize, moonSize);
        
        if(s.hasMessage) {
            ctx.fillStyle = s.opened ? 'orange' : '#0f0';
            const rawText = s.title || s.id.toString();
            const text = rawText.substring(0, 15);
            ctx.fillText(text, sx, sy - moonSize/2 - 15*DPR);
        }
        continue;
    }
    
    const pulse=Math.sin(time*s.pulseSpeed/1000 + s.phase)*0.3 + 0.7;
    const glow=s.size*(5+pulse*3);
    const brightness=s.brightness*pulse;
    ctx.save();
    const grad=ctx.createRadialGradient(sx,sy,0,sx,sy,glow);
    grad.addColorStop(0,`rgba(255,255,255,${0.8*brightness})`);
    grad.addColorStop(0.3,`rgba(255,255,255,${0.4*brightness})`);
    grad.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(sx,sy,glow,0,Math.PI*2); ctx.fill(); ctx.restore();
    ctx.beginPath();
    
    let starColor = '#fff';  
    
    if (s.hasMessage) {
        starColor = s.opened ? 'orange' : '#0f0';  
    }  
    
    ctx.fillStyle = starColor;
    ctx.globalAlpha=brightness; ctx.arc(sx,sy,s.size,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=1;
    
    let textColor = '#fff';  
    
    if (s.hasMessage) {
        textColor = starColor;
    } else {
        textColor = '#fff';
    }

    ctx.fillStyle = s.title ? textColor : '#fff';  
    
    const rawText = s.title || s.id.toString();
    const text = rawText.substring(0, 15);  
    
    ctx.fillText(text,sx,sy-15*DPR);
  }
}

function update(dt){
    if (isAutoMoving) {
        const smoothing = 0.05;
        const dx = camera.tx - camera.x;
        const dy = camera.ty - camera.y;
        
        if (Math.hypot(dx, dy) < 10) { 
            camera.x = camera.tx;
            camera.y = camera.ty;
            isAutoMoving = false;
        } else {
            camera.x += dx * smoothing * 60 * dt;
            camera.y += dy * smoothing * 60 * dt;
        }
    }
    generateNearby();
}

let currentStarIndex = -1;

function resetStarNavigation() {
    currentStarIndex = -1;
    console.log("ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙÙ‡Ø±Ø³ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù†Ø¬ÙˆÙ…");
}

navigateStarBtn.onclick = () => {
    let starsWithMessage = stars.filter(s => s.hasMessage);
    
    switch (navigationMode) {
        case 'favorites':
            starsWithMessage = starsWithMessage.filter(s => 
    currentUser.favorites.includes(s.id)
);
            break;
    }
    
    if (messageStatusFilter !== 'all') {
        starsWithMessage = starsWithMessage.filter(s => {
            const isRead = currentUser.readStarIds[s.id] || false;
            return messageStatusFilter === 'read' ? isRead : !isRead;
        });
    }
    
    starsWithMessage.sort((a, b) => a.id - b.id);
    
    if (starsWithMessage.length === 0) {
        showError("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„ÙŠØ©.");
        return;
    }
    
    if (currentStarIndex >= starsWithMessage.length || currentStarIndex < 0) {
        resetStarNavigation();
    }
    
    currentStarIndex = (currentStarIndex + 1) % starsWithMessage.length;
    
    const targetStar = starsWithMessage[currentStarIndex];
    
    camera.tx = targetStar.x;
    camera.ty = targetStar.y;
    
    isAutoMoving = true;
    
    lastTouchedStar = targetStar;
    showStarMessage(targetStar);
    
    if (targetStar.hasMessage && !targetStar.opened) {
        targetStar.opened = true;
        if (!currentUser.readStarIds[targetStar.id]) {
            currentUser.readStarIds[targetStar.id] = true;
            saveUserToLocal();
        }
    }
    
    console.log(`ğŸ“ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¬Ù…Ø© ${currentStarIndex + 1} Ù…Ù† ${starsWithMessage.length} (ID: ${targetStar.id})`);
};

let isDragging = false;
let lastPointerX, lastPointerY;
const DRAG_SENSITIVITY = 1.0; 

canvas.addEventListener('pointerdown', e => {
    if (e.target.closest('#navigateStarBtn, #messageModal, #userPanel, #fabButton, #likersModal, #controlButtons, #favoritesModal, #replyModal')) {
        isDragging = false;
        return;
    }
    
    isDragging = true;
    lastPointerX = e.clientX;
    lastPointerY = e.clientY;
    
    isAutoMoving = false;

    e.preventDefault(); 
    canvas.setPointerCapture(e.pointerId); 
});

canvas.addEventListener('pointermove', e => {
    if (!isDragging) return;
    
    const dx = e.clientX - lastPointerX;
    const dy = e.clientY - lastPointerY;

    camera.x -= dx * DRAG_SENSITIVITY * DPR; 
    camera.y -= dy * DRAG_SENSITIVITY * DPR;
    camera.tx = camera.x;
    camera.ty = camera.y;

    lastPointerX = e.clientX;
    lastPointerY = e.clientY;
});

canvas.addEventListener('pointerup', () => {
    isDragging = false;
});

titleInput.addEventListener('input', () => {
  titleInput.value = titleInput.value.slice(0, 15);
});

function bindMessagesToStars(messagesCache){
  console.log(`ğŸ”— Ø¬Ø§Ø±ÙŠ Ø±Ø¨Ø· ${messagesCache.size} Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ù„Ù†Ø¬ÙˆÙ…...`);
  
  stars.forEach(s => {
    s.message = null;
    s.hasMessage = false;
    s.title = null;
    s.opened = false;
    s.docId = null;  
    s.uid = null;  
    s.isPinned = false;  
  });
  
  const readStarIds = currentUser.readStarIds || {};

  let matchedCount = 0;
  
  messagesCache.forEach((data, id) => {
    const starId = parseInt(id);
    const star = stars.find(s => s.id === starId);  
    
    if (star) {
      star.message = data.text || null;  
      star.hasMessage = !!data.text;
      star.title = data.title || null;  
      star.docId = id.toString();  
      star.uid = data.uid || null;  
      star.opened = !!readStarIds[starId];
      matchedCount++;
    }
  });
  
  console.log(`âœ… ØªÙ… Ø±Ø¨Ø· ${matchedCount} Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬ÙˆÙ… Ù…ÙˆØ¬ÙˆØ¯Ø©`);
  
  resetStarNavigation(); 
  draw(performance.now());
  
  updateMessageCounts();
}

function updateMessageCounts() {
    const starsWithMessage = stars.filter(s => s.hasMessage);
    const allCount = starsWithMessage.length;
    const favoritesCount = starsWithMessage.filter(s => 
    currentUser.favorites.includes(s.id)
).length;
    
    allMessagesCount.innerText = allCount;
    favoritesMessagesCount.innerText = favoritesCount;
}

async function loadAndCacheStars(){
  try {
    console.log("ğŸš€ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Firebase...");
    const querySnapshot = await getDocs(MESSAGES_COLLECTION);
    
    cachedMessages.clear();
    querySnapshot.forEach((doc) => {
        cachedMessages.set(doc.id, doc.data());
    });
    
    console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${cachedMessages.size} Ø±Ø³Ø§Ù„Ø© Ù…Ù† Firebase`);
    
    bindMessagesToStars(cachedMessages);  

  } catch (error) {
    console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¬ÙˆÙ… Ù…Ù† Firebase:", error);
  }
}

canvas.addEventListener('click', e=>{
  if (e.target.closest('#controlButtons')) {
      return;
  }
  
  isAutoMoving = false;
  closePanel();  

  const rect=canvas.getBoundingClientRect();
  const x=(e.clientX-rect.left)*DPR;
  const y=(e.clientY-rect.top)*DPR;
  const cx=canvas.width/2,cy=canvas.height/2;
  let nearest=null,minDist=15*DPR;
  for(const s of stars){
    const sx=(s.x-camera.x)+cx;
    const sy=(s.y-camera.y)+cy;
    const d=Math.hypot(sx-x,sy-y);
    if(d<minDist){nearest=s;minDist=d;}
  }
  if(nearest){
  lastTouchedStar = nearest;  
  
  document.querySelectorAll('.starMessage').forEach(div => {
      if (div.classList.contains('pinned') && parseInt(div.dataset.starId) !== nearest.id) return;
      
      const starId = parseInt(div.dataset.starId);
      const star = stars.find(s => s.id === starId);
      if (star) hideStarMessageDiv(div, star);
  });
  
  fabButton.style.display = 'none';
  
  toggleControlButtons(true);
  
  updateLikersButton(nearest.id.toString());
  
  const existingDiv = document.querySelector(`.starMessage[data-star-id="${nearest.id}"]`);
  updatePinButtonText(existingDiv && existingDiv.classList.contains('pinned'));
  
  if(!nearest.hasMessage){
    activeStar=nearest;
    messageInput.value="";
    titleInput.value="";
    messageModal.style.display="block";
    
    setTimeout(() => titleInput.focus(), 10);
    
  } else if(!nearest.showing){
    showStarMessage(nearest);
    
    if (nearest.hasMessage && !nearest.opened) {
            nearest.opened = true;  

            if (!currentUser.readStarIds[nearest.id]) {
                currentUser.readStarIds[nearest.id] = true;
                saveUserToLocal();
            }
    }
    
    const currentDiv = document.querySelector(`.starMessage[data-star-id="${nearest.id}"]`);
    updatePinButtonText(currentDiv && currentDiv.classList.contains('pinned'));
  }
} else {
  toggleControlButtons(false);
  
  const anyMessageOpen = stars.some(s => s.showing && s.hasMessage);
  if (!anyMessageOpen) {
      fabButton.style.display = 'block';
  }
}
});

document.addEventListener('click', (e) => {
    if (!e.target.closest('#controlButtons') && 
        !e.target.closest('canvas') && 
        !e.target.closest('.starMessage') &&
        !e.target.closest('#userPanel') &&
        !e.target.closest('#fabButton') &&
        !e.target.closest('#likersModal') &&
        !e.target.closest('#favoritesModal') &&
        !e.target.closest('#replyModal')) {
        toggleControlButtons(false);
    }
});

sendBtn.onclick = async () => {
  sendBtn.disabled = true;

  if (activeStar) {
    const messageText = messageInput.value.trim();
    const titleText = titleInput.value.trim();
    const starId = activeStar.id.toString();  

    const title = titleText || 'Ø±Ø³Ø§Ù„Ø© Ø²Ø§Ø¦Ø±';

    if (messageText === "") {
        if (activeStar.hasMessage) {
              try {
                await deleteDoc(doc(MESSAGES_COLLECTION, starId));
                console.log("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† ÙØ§ÙŠØ¨Ø±Ø¨ÙŠØ³ Ø¨Ø¹Ø¯ Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰:", starId);
                
                cachedMessages.delete(starId);
                bindMessagesToStars(cachedMessages);  

              } catch (e) {
                console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù Ù…Ù† ÙØ§ÙŠØ¨Ø±Ø¨ÙŠØ³:", e);
                showError("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„.");
              }
        }
        
        activeStar.message = null;
        activeStar.hasMessage = false;
        activeStar.title = null;
        activeStar.showing = false;
        activeStar.uid = null;
        activeStar.docId = null;  
        console.log("âš ï¸ ØªÙ… Ø¥Ù„ØºØ§Ø¡/Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©.");
    } else {
      try {
        const newMessageData = {
            title: title,  
            userName: currentUser.displayName,  
            text: messageText,  
            uid: currentUser.uid,  
            updatedAt: new Date().toISOString(),
            createdAt: new Date().toISOString()
        };
        
        await setDoc(doc(MESSAGES_COLLECTION, starId), newMessageData);
        
        console.log(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ ÙØ§ÙŠØ¨Ø±Ø¨ÙŠØ³ Ù„Ù„Ù…ÙØªØ§Ø­: ${starId}`);
        
        cachedMessages.set(starId, newMessageData);
        
        activeStar.opened = true;
        
        bindMessagesToStars(cachedMessages);

      } catch (e) {
        console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ ÙÙŠ ÙØ§ÙŠØ¨Ø±Ø¨ÙŠØ³:", e);
        showError("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„.");
      }
    }
    
    sendBtn.disabled = false;
    messageModal.style.display = "none";
    activeStar = null;
    lastTouchedStar = null;
    
    updateMessageCounts();
  }
};

cancelBtn.onclick=()=>{messageModal.style.display="none";activeStar=null;};

  function playMessageSound() {
      const audio = new Audio('audio/open_message.mp3');
      audio.play().catch(e => {
          console.warn("âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:", e);
      });
  }
  
function showStarMessage(star){
  document.querySelectorAll('.starMessage:not(.pinned)').forEach(div => {
      const starId = parseInt(div.dataset.starId);
      const s = stars.find(s => s.id === starId);
      if (s) hideStarMessageDiv(div, s);
  });
  
  const existingPinnedDiv = document.querySelector(`.starMessage[data-star-id="${star.id}"].pinned`);
  if(star.showing && !existingPinnedDiv) {
    return;
  }
  
  if (!star.showing) {
       playMessageSound();
  }
  
  let div = document.querySelector(`.starMessage[data-star-id="${star.id}"]`);
  
  if (!div) {
      star.showing = true;
      
      fabButton.style.display = 'none';
      
      const canvasRect = canvas.getBoundingClientRect();
      const cx = canvas.width/2, cy = canvas.height/2;

      div = document.createElement('div');
      div.className = 'starMessage';
      div.dataset.starId = star.id;  
      
      const ownerName = star.title || 'Ù…Ø¬Ù‡ÙˆÙ„';  
      div.innerText = star.message;  

      
      div.style.color = '#87CEEB';  

      document.body.appendChild(div);
      
      let sx = (star.x - camera.x) + cx;
      let sy = (star.y - camera.y) + cy;
      const divRect = div.getBoundingClientRect();
      let left = canvasRect.left + sx/DPR - divRect.width/2;
      let top = canvasRect.top + sy/DPR - divRect.height - 10;
      left = Math.max(5, Math.min(left, window.innerWidth - divRect.width - 5));
      top = Math.max(5, Math.min(top, window.innerHeight - divRect.height - 5));
      div.style.left = left + 'px';
      div.style.top = top + 'px';

      div.style.opacity = 1;
      
      div.outsideClick = function(e){  
          if(!div.contains(e.target) && e.target !== navigateStarBtn && !e.target.closest('#controlButtons')){  
              clearTimeout(star.hideTimeout);  
              hideStarMessageDiv(div, star);  
              document.removeEventListener('pointerdown', div.outsideClick);  
          }  
      };
      document.addEventListener('pointerdown', div.outsideClick);
  } else {
      div.style.opacity = 1;
      star.showing = true;
      clearTimeout(star.hideTimeout);
  }

  if (!div.classList.contains('pinned')) {
      clearTimeout(star.hideTimeout);
      star.hideTimeout = setTimeout(() => hideStarMessageDiv(div, star), 5000);
  }
  
  div.addEventListener('pointerdown', ()=>{  
      if(!div.classList.contains('pinned')){  
          clearTimeout(star.hideTimeout);  
          star.hideTimeout = setTimeout(() => hideStarMessageDiv(div, star), 5000);  
      }  
  });
}

let last=performance.now();

function loop(now){const dt=(now-last)/1000;last=now;update(dt);draw(now);requestAnimationFrame(loop);}
generateNearby();

function formatArabicDate(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
    const dayName = days[date.getDay()];
    
    if (date.toDateString() === now.toDateString()) {
        return `Ø§Ù„ÙŠÙˆÙ… ${date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}`;
    }
    else if (date.toDateString() === yesterday.toDateString()) {
        return `Ø£Ù…Ø³ ${date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}`;
    }
    else if ((now - date) < 7 * 24 * 60 * 60 * 1000) {
        return `${dayName} ${date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}`;
    }
else {
    const day = date.getDate();
    const month = date.getMonth() + 1;
    const year = date.getFullYear();
    return `${dayName} ${day}/${month}/${year} ${date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}`;
}
}

function showError(message) {
    alert(`âŒ ${message}`);
}

function showSuccess(message) {
    alert(`âœ… ${message}`);
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¨Ø§Ø´Ø±Ø©
updateUI();  
camera.tx = camera.x;
camera.ty = camera.y;

requestAnimationFrame(loop);

</script>
</body>
</html>
